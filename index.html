<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reaksa Ads - V51 Enter Key</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@300;400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CSS Variables */
        :root {
            --bg-body: #f1f5f9; --sidebar-bg: #0f172a; --card-bg: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
            --primary: #2563eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --font-main: 'Inter', 'Battambang', sans-serif;
        }
        body.dark-mode {
            --bg-body: #0f172a; --sidebar-bg: #1e293b; --card-bg: #1e293b;
            --text-main: #f8fafc; --text-sub: #94a3b8; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* --- MOBILE HEADER --- */
        .mobile-header {
            display: none; background: var(--sidebar-bg); padding: 15px 20px;
            align-items: center; justify-content: space-between;
            color: white; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .menu-toggle { font-size: 24px; cursor: pointer; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 260px; background: var(--sidebar-bg); color: white; 
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 2001; 
            border-right: 1px solid rgba(255,255,255,0.1); height: 100vh;
            transition: transform 0.3s ease;
        }
        .sidebar-header { 
            padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; 
        }
        .app-logo { 
            width: 70px; height: 70px; border-radius: 14px; margin-bottom: 15px; 
            object-fit: contain; background: white; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .brand-title {
            font-size: 22px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 2px;
            background: linear-gradient(90deg, #ffffff, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .brand-sub { font-size: 10px; opacity: 0.6; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 500; }
        .menu-item { padding: 12px 20px; margin: 0 10px 5px; border-radius: 8px; cursor: pointer; color: #94a3b8; display: flex; gap: 12px; align-items: center; font-size: 14px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }

        /* OVERLAY */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; position: relative; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }

        /* COMPONENTS */
        .white-box { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-main); outline: none; }
        
        /* TABLES */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; background: var(--bg-body); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text-sub); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; font-family: var(--font-main); white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-dark { background: #334155; color: white; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; white-space: nowrap; }
        .bg-paid { background: #dcfce7; color: #166534; } .bg-pending { background: #f3f4f6; color: #4b5563; }
        .bg-overdue { background: #fee2e2; color: #991b1b; } .bg-due { background: #fef3c7; color: #b45309; }
        .alert-box { background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; margin-bottom: 20px; border-radius: 6px; display: none; }

        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 900px; display: flex; overflow: hidden; }
        .login-left { flex: 1; background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 40px; }
        .login-right { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        
        .inp-login { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; transition: 0.3s; }
        .inp-login:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Password Toggle */
        .password-wrapper { position: relative; margin-bottom: 15px; }
        .password-wrapper .inp-login { margin-bottom: 0; padding-right: 40px; }
        .toggle-eye { 
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
            color: #94a3b8; cursor: pointer; font-size: 14px;
        }
        .toggle-eye:hover { color: var(--primary); }

        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { 
            body { flex-direction: column; } .mobile-header { display: flex; } .sidebar { position: fixed; top: 0; left: -280px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.active { left: 0; } .overlay.active { display: block; } .main-content { padding-top: 60px; } .scroll-area { padding: 15px; } .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .login-card { flex-direction: column; width: 90%; padding: 0; } .login-left { display: none; } .login-right { padding: 30px; }
            .white-box { padding: 15px; } .form-grid-mobile { display: flex; flex-direction: column; gap: 15px; } .mobile-stack { flex-direction: column; gap: 15px; }
        }
        #invoice-capture { position: fixed; left: -9999px; top: 0; width: 800px; background: white; padding: 50px; font-family: 'Inter', sans-serif; color: #111827; z-index: -1; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div style="font-weight: 700; font-size: 18px;">Reaksa Ads</div>
        <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div id="loginOverlay">
        <div class="login-card">
            <div class="login-left">
                <i class="fab fa-slack" style="font-size: 80px; margin-bottom: 20px;"></i>
                <h2 style="font-size: 28px; font-weight: 800;">Reaksa Ads</h2>
                <p style="opacity: 0.8;">Intelligent Solutions</p>
            </div>
            <div class="login-right">
                <div style="margin-bottom: 20px; text-align: center;">
                    <h2 style="color: var(--text-main);">Sign In</h2>
                    <p style="color: var(--text-sub); font-size: 14px;">System V51 - Enter Key Support</p>
                </div>
                
                <div style="text-align:left; font-size:12px; font-weight:600; margin-bottom:5px;">Email</div>
                <input type="text" id="loginEmail" class="inp-login" placeholder="Email (adsreaksa@gmail.com)">
                
                <div style="text-align:left; font-size:12px; font-weight:600; margin-bottom:5px;">Password</div>
                <div class="password-wrapper">
                    <input type="password" id="loginPass" class="inp-login" placeholder="Password">
                    <i class="fas fa-eye toggle-eye" id="eyeIcon" onclick="togglePassword()"></i>
                </div>

                <button onclick="checkLogin()" class="btn-login">Login Account</button>
            </div>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://i.postimg.cc/kXrbxQ40/reaksa-logo-placeholder.png" id="appLogoDisplay" class="app-logo" onerror="this.src='https://ui-avatars.com/api/?name=Reaksa+Ads&background=fff&color=2563eb&size=128&rounded=true'">
            <div class="brand-title">Reaksa Ads</div>
            <div class="brand-sub">INTELLIGENT SOLUTIONS</div>
        </div>

        <div class="menu-item active" id="nav-dash" onclick="switchTab('dash')"><i class="fas fa-th-large"></i> <span class="lang-dash">Dashboard</span></div>
        <div class="menu-item" id="nav-inv" onclick="switchTab('inv')"><i class="fas fa-file-invoice"></i> <span class="lang-inv">Invoices</span></div>
        <div class="menu-item" id="nav-exp" onclick="switchTab('exp')"><i class="fas fa-chart-pie"></i> <span class="lang-exp">Expenses</span></div>
        <div class="menu-item" id="nav-cli" onclick="switchTab('cli')"><i class="fas fa-users"></i> <span class="lang-cli">Clients</span></div>
        <div class="menu-item" id="nav-set" onclick="switchTab('set')"><i class="fas fa-cog"></i> <span class="lang-set">Settings</span></div>
    </aside>

    <main class="main-content">
        <div class="scroll-area">
            
            <div id="view-dash" class="view-section">
                <div id="alertBox" class="alert-box"><h4 style="margin:0 0 5px 0; color:#991b1b;"><i class="fas fa-bell"></i> Alert</h4><p style="margin:0; font-size:14px; color:#7f1d1d;" id="alertMsg"></p></div>

                <div class="stats-grid">
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-rev">REVENUE</small><h2 style="color:var(--primary)" id="stRev">$0.00</h2></div><i class="fas fa-wallet" style="font-size:24px; color:var(--primary)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-exp-cost">EXPENSES</small><h2 style="color:var(--danger)" id="stExp">$0.00</h2></div><i class="fas fa-arrow-down" style="font-size:24px; color:var(--danger)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-prof">PROFIT</small><h2 style="color:var(--success)" id="stProf">$0.00</h2></div><i class="fas fa-chart-line" style="font-size:24px; color:var(--success)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-over">OVERDUE</small><h2 style="color:var(--danger)" id="stDue">0</h2></div><i class="fas fa-exclamation-circle" style="font-size:24px; color:var(--danger)"></i></div>
                </div>

                <div class="white-box" style="height: 350px; position: relative;">
                    <h3 style="margin-bottom: 20px;" class="lang-chart">Financial Overview</h3>
                    <canvas id="revenueChart"></canvas>
                </div>

                <div class="white-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3 id="formTitle" class="lang-new-inv">Create New Invoice</h3>
                        <button onclick="resetForm()" class="btn" id="btnCancel" style="background:var(--text-main); color:white; display:none;">Cancel</button>
                    </div>
                    
                    <div class="form-grid-mobile" style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div><label style="font-size:12px; font-weight:600;" class="lang-client">Client Name</label><input type="text" id="inpClient" class="form-control" placeholder="Select Client" list="clientList"><datalist id="clientList"></datalist></div>
                        <div><label style="font-size:12px; font-weight:600;">Invoice #</label><input type="text" id="inpInvNum" class="form-control" placeholder="INV-001"></div>
                        <div><label style="font-size:12px; font-weight:600;" class="lang-date">Start Date</label><input type="date" id="inpDate" class="form-control"></div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <label style="font-size:12px; font-weight:600; color:var(--danger);" class="lang-due">Payment Due Date</label>
                        <input type="date" id="inpDue" class="form-control" style="border-color:var(--danger);">
                    </div>

                    <div class="table-responsive">
                        <table style="margin-bottom:15px;">
                            <thead><tr><th class="lang-desc">Description</th><th style="width:100px;">Qty</th><th style="width:150px;">Price ($)</th><th style="width:50px;"></th></tr></thead>
                            <tbody id="itemContainer"></tbody>
                        </table>
                    </div>
                    <button onclick="addRow()" class="btn" style="background:#eff6ff; color:var(--primary);">+ Add Item</button>

                    <div class="mobile-stack" style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px; width: 100%;">
                            <select id="inpStatus" class="form-control" style="width:150px;"><option value="Pending">Pending</option><option value="Paid">Paid</option></select>
                            <span style="font-size:18px; font-weight:700; white-space:nowrap;">Total: <span id="displayTotal">$0.00</span></span>
                        </div>
                        <button onclick="saveInvoice()" class="btn btn-primary" id="btnSave">Save Invoice</button>
                    </div>
                </div>
            </div>

            <div id="view-inv" class="view-section" style="display:none;"><div class="white-box" style="padding:0; overflow:hidden;"><div style="padding:20px; border-bottom:1px solid var(--border);"><h3 class="lang-hist">Invoices History</h3></div><div class="table-responsive"><table style="width:100%;"><thead><tr><th>ID</th><th class="lang-client">Client</th><th class="lang-date">Date</th><th class="lang-due">Due Date</th><th>Total</th><th>Status</th><th>Action</th></tr></thead><tbody id="invoiceTable"></tbody></table></div></div></div>
            <div id="view-exp" class="view-section" style="display:none;"><div class="white-box"><h3 class="lang-exp">Expenses</h3><div class="form-grid-mobile" style="display:flex; gap:10px; margin:15px 0;"><input id="expDesc" class="form-control" placeholder="Description"><input type="number" id="expAmt" class="form-control" placeholder="Amount"><button onclick="saveExpense()" class="btn btn-danger">Add</button></div><div class="table-responsive"><table style="width:100%"><thead><tr><th>Desc</th><th>Date</th><th>Amount</th><th>Action</th></tr></thead><tbody id="expenseTable"></tbody></table></div></div></div>
            <div id="view-cli" class="view-section" style="display:none;"><div class="white-box"><h3 class="lang-cli">Clients</h3><div class="form-grid-mobile" style="display:flex; gap:10px; margin:15px 0;"><input id="cliName" class="form-control" placeholder="Name"><input id="cliPhone" class="form-control" placeholder="Phone"><button onclick="saveClient()" class="btn btn-primary">Add</button></div><div class="table-responsive"><table style="width:100%"><thead><tr><th>Name</th><th>Phone</th><th>Action</th></tr></thead><tbody id="clientTable"></tbody></table></div></div></div>
            <div id="view-set" class="view-section" style="display:none;">
                <div class="white-box">
                    <h3 class="lang-set">Settings</h3>
                    <div style="margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;"><div><b>System Language</b><br><small>ភាសា</small></div><select id="langSelect" class="form-control" style="width:150px;" onchange="changeLang(this.value)"><option value="en">English</option><option value="km">ភាសាខ្មែរ</option></select></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;"><div><b>Company Logo</b><br><small>Replaces the blue 'R' logo</small></div><div style="display:flex; gap:10px;"><input type="file" id="logoInput" style="display:none;" onchange="uploadLogo(this)"><button onclick="document.getElementById('logoInput').click()" class="btn btn-primary">Upload</button><button onclick="removeLogo()" class="btn btn-danger">Reset</button></div></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;"><div><b>Telegram Bot</b><br><small>Test Connection</small></div><button onclick="testTelegram()" class="btn btn-success">Test</button></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>Exchange Rate</span><input id="setRate" class="form-control" style="width:100px;" value="4100" onchange="localStorage.setItem('agRate',this.value)"></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>Backup</span><button onclick="downloadData()" class="btn btn-dark">Download</button></div>
                        <div style="display:flex; justify-content:space-between;"><span>Reset</span><button onclick="if(confirm('Delete All?')){localStorage.clear();location.reload()}" class="btn btn-danger">Reset</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="invoice-capture">
        <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
            <div><img src="" id="invLogo" style="height:60px; display:none; margin-bottom:10px;"><h1 style="margin:0; font-size:26px;" id="invBrandName">Reaksa Ads</h1><p style="margin:5px 0; color:#6b7280; font-size:12px; letter-spacing:2px;">INTELLIGENT SOLUTIONS</p></div>
            <div style="text-align:right;"><h2 style="margin:0; color:#2563eb;">INVOICE</h2><div style="color:#6b7280;"># <span id="outNum"></span></div></div>
        </div>
        <div style="display:flex; justify-content:space-between; background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:30px;"><div><div style="font-size:11px; color:#6b7280; font-weight:700;">BILL TO</div><div style="font-size:16px; font-weight:700;" id="outClient"></div></div><div style="text-align:right;"><div style="font-size:11px; color:#6b7280; font-weight:700;">PAYMENT DUE</div><div style="font-size:16px; font-weight:700; color:#ef4444;" id="outDue"></div></div></div>
        <table style="width:100%; border-collapse:collapse; margin-bottom:30px;"><thead><tr style="border-bottom:2px solid #e5e7eb;"><th style="text-align:left; padding:10px 0;">DESCRIPTION</th><th style="text-align:center;">QTY</th><th style="text-align:right;">PRICE</th><th style="text-align:right;">TOTAL</th></tr></thead><tbody id="outItems"></tbody></table>
        <div style="display:flex; justify-content:flex-end;"><div style="width:250px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Total (USD)</span><span id="outTotal" style="font-weight:700;">$0.00</span></div><div style="display:flex; justify-content:space-between; color:#6b7280;"><span>Total (KHR)</span><span id="outKhr">0 ៛</span></div></div></div>
        <div style="margin-top:50px; border-top:1px solid #e5e7eb; padding-top:20px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; gap:15px; align-items:center;"><img src="https://i.postimg.cc/NM5461RZ/aba_qr.jpg" style="width:80px;" crossorigin="anonymous"><div><div style="font-size:12px; font-weight:700;">ABA: 002 060 042</div><div style="font-size:12px;">Reaksa Ads</div></div></div><div style="text-align:right; font-size:12px; color:#6b7280;"><div>015 812 050 | 068 566 402</div><div>t.me/ReaksaAds</div></div></div>
    </div>

    <script>
        const BOT_TOKEN="8269889459:AAFCHuvYXeEVzcK7bsWqxPvFgQp8yMwGVAQ", CHAT_ID="6459933568"; 
        let invoices=JSON.parse(localStorage.getItem('agDataV46'))||[], clients=JSON.parse(localStorage.getItem('agCliV46'))||[], expenses=JSON.parse(localStorage.getItem('agExpV46'))||[], myChart=null, editingId=null;
        const trans={en:{dash:"Dashboard",inv:"Invoices",exp:"Expenses",cli:"Clients",set:"Settings",rev:"REVENUE",exp_cost:"EXPENSES",prof:"PROFIT",over:"OVERDUE",chart:"Financial Overview",new_inv:"Create New Invoice",client:"Client Name",date:"Issue Date",due:"Payment Due Date",desc:"Description",hist:"Invoice History"},km:{dash:"ផ្ទាំងគ្រប់គ្រង",inv:"វិក្កយបត្រ",exp:"ចំណាយ",cli:"អតិថិជន",set:"ការកំណត់",rev:"ចំណូលសរុប",exp_cost:"ចំណាយសរុប",prof:"ប្រាក់ចំណេញ",over:"ហួសកំណត់",chart:"របាយការណ៍ហិរញ្ញវត្ថុ",new_inv:"បង្កើតវិក្កយបត្រថ្មី",client:"ឈ្មោះអតិថិជន",date:"ថ្ងៃចេញវិក្កយបត្រ",due:"ថ្ងៃត្រូវបង់លុយ",desc:"បរិយាយ",hist:"ប្រវត្តិវិក្កយបត្រ"}};

        // PASSWORD TOGGLE
        function togglePassword() {
            const inp = document.getElementById('loginPass');
            const icon = document.getElementById('eyeIcon');
            if(inp.type === "password") {
                inp.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
            } else {
                inp.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
            }
        }

        // ENTER KEY LOGIN
        document.getElementById('loginEmail').addEventListener('keypress', function (e) { if (e.key === 'Enter') checkLogin(); });
        document.getElementById('loginPass').addEventListener('keypress', function (e) { if (e.key === 'Enter') checkLogin(); });

        function checkLogin(){ if(document.getElementById('loginEmail').value==="adsreaksa@gmail.com"&&document.getElementById('loginPass').value==="adsreaksa050796"){document.getElementById('loginOverlay').style.display='none';initApp()}else alert("Invalid Login") }
        function initApp(){ document.getElementById('inpDate').value=new Date().toISOString().split('T')[0]; document.getElementById('setRate').value=localStorage.getItem('agRate')||4100; const l=localStorage.getItem('agLang')||'en'; document.getElementById('langSelect').value=l; changeLang(l); loadLogo(); updateStats(); renderTable(); renderClients(); renderExpenses(); addRow(); genInvNum(); renderChart(); checkAlerts(); }
        function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
        function switchTab(id){ document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); document.querySelectorAll('.view-section').forEach(e=>e.style.display='none'); document.getElementById('view-'+id).style.display='block'; if(id==='dash')renderChart(); document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        function changeLang(l){ localStorage.setItem('agLang',l); for(let k in trans[l]) if(document.querySelector('.lang-'+k)) document.querySelector('.lang-'+k).innerText=trans[l][k]; }
        
        function uploadLogo(i){ const f=i.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{localStorage.setItem('agLogo',e.target.result);loadLogo()}; r.readAsDataURL(f) } }
        function removeLogo(){ localStorage.removeItem('agLogo'); loadLogo(); }
        function loadLogo(){ 
            const l=localStorage.getItem('agLogo'), d=document.getElementById('appLogoDisplay'), inv=document.getElementById('invLogo'), txt=document.getElementById('invBrandName');
            if(l){ d.src=l; inv.src=l; inv.style.display='block'; txt.style.display='none'; } 
            else { d.src="https://i.postimg.cc/kXrbxQ40/reaksa-logo-placeholder.png"; inv.style.display='none'; txt.style.display='block'; }
        }

        function testTelegram(){ const b=event.target,t=b.innerHTML; b.innerHTML="Sending..."; fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:CHAT_ID,text:"✅ System Connected!"})}).then(r=>r.json()).then(d=>{if(d.ok)alert("✅ Success!");else alert("❌ Error")}).finally(()=>b.innerHTML=t) }
        function sendTelegram(d){ fillTemplate(d); const b=event.target.closest('button'),t=b.innerHTML; b.innerText="..."; setTimeout(()=>{html2canvas(document.getElementById("invoice-capture"),{scale:2,useCORS:true}).then(c=>{c.toBlob(bl=>{const f=new FormData();f.append('chat_id',CHAT_ID);f.append('photo',bl);fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{method:'POST',body:f}).then(r=>r.json()).then(d=>{if(d.ok){b.innerHTML='✅';setTimeout(()=>b.innerHTML=t,2000)}else alert(d.description)})})})},500) }
        function checkAlerts(){ const t=new Date().toISOString().split('T')[0]; let c=0; invoices.forEach(i=>{if(i.status!=='Paid'&&i.dueDate&&i.dueDate<=t)c++}); if(c>0){document.getElementById('alertBox').style.display='block';document.getElementById('alertMsg').innerText=`${c} overdue invoices!`;document.getElementById('stDue').innerText=c}else{document.getElementById('alertBox').style.display='none';document.getElementById('stDue').innerText="0"} }
        function addRow(d='',q=1,p=''){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input class="form-control i-desc" value="${d}"></td><td><input type="number" class="form-control i-qty" value="${q}" oninput="calc()"></td><td><input type="number" class="form-control i-price" value="${p}" oninput="calc()"></td><td><i class="fas fa-times" style="color:red;cursor:pointer" onclick="this.closest('tr').remove();calc()"></i></td>`; document.getElementById('itemContainer').appendChild(tr) }
        function calc(){ let t=0; document.querySelectorAll('#itemContainer tr').forEach(r=>{t+=(r.querySelector('.i-qty').value||0)*(r.querySelector('.i-price').value||0)}); document.getElementById('displayTotal').innerText="$"+t.toFixed(2); return t }
        function genInvNum(){ if(!editingId)document.getElementById('inpInvNum').value="INV-"+(invoices.length+1).toString().padStart(3,'0') }
        function saveInvoice(){ const c=document.getElementById('inpClient').value; if(!c)return alert("Client?"); const its=[]; document.querySelectorAll('#itemContainer tr').forEach(r=>{if(r.querySelector('.i-desc').value)its.push({desc:r.querySelector('.i-desc').value,qty:r.querySelector('.i-qty').value,price:r.querySelector('.i-price').value})}); if(its.length==0)return alert("Items?"); const inv={id:editingId||Date.now(),num:document.getElementById('inpInvNum').value,client:c,items:its,total:calc(),status:document.getElementById('inpStatus').value,date:document.getElementById('inpDate').value,dueDate:document.getElementById('inpDue').value}; if(editingId)invoices[invoices.findIndex(i=>i.id===editingId)]=inv; else invoices.unshift(inv); localStorage.setItem('agDataV46',JSON.stringify(invoices)); resetForm(); updateStats(); renderTable(); renderChart(); checkAlerts(); alert("Saved!") }
        function resetForm(){ editingId=null; document.getElementById('inpClient').value=""; document.getElementById('inpDue').value=""; document.getElementById('itemContainer').innerHTML=""; document.getElementById('formTitle').innerText="Create New Invoice"; document.getElementById('btnSave').innerText="Save Invoice"; document.getElementById('btnCancel').style.display='none'; addRow(); genInvNum(); calc() }
        function editInv(s){ const d=JSON.parse(decodeURIComponent(s)); editingId=d.id; document.getElementById('inpClient').value=d.client; document.getElementById('inpInvNum').value=d.num; document.getElementById('inpDate').value=d.date; document.getElementById('inpStatus').value=d.status; document.getElementById('inpDue').value=d.dueDate||""; document.getElementById('itemContainer').innerHTML=""; d.items.forEach(i=>addRow(i.desc,i.qty,i.price)); calc(); document.getElementById('formTitle').innerText="Edit Invoice"; document.getElementById('btnSave').innerText="Update"; document.getElementById('btnCancel').style.display='inline-flex'; switchTab('dash') }
        function renderTable(){ const tb=document.getElementById('invoiceTable'); tb.innerHTML=""; const t=new Date().toISOString().split('T')[0]; invoices.forEach(i=>{ let b='bg-pending',x=i.status; if(i.status=='Paid')b='bg-paid'; else if(i.dueDate&&i.dueDate<t){b='bg-overdue';x='Overdue'} else if(i.dueDate&&i.dueDate===t){b='bg-due';x='Due Today'} tb.innerHTML+=`<tr><td>${i.num}</td><td>${i.client}</td><td>${i.date}</td><td style="color:${b==='bg-overdue'?'red':'inherit'}">${i.dueDate||'-'}</td><td>$${i.total.toFixed(2)}</td><td><span class="badge ${b}">${x}</span></td><td style="display:flex;gap:8px"><button class="btn" style="color:blue" onclick="editInv('${encodeURIComponent(JSON.stringify(i))}')"><i class="fas fa-edit"></i></button><button class="btn" style="color:green" onclick='sendTelegram(${JSON.stringify(i)})'><i class="fab fa-telegram"></i></button><button class="btn" style="color:red" onclick="delInv(${i.id})"><i class="fas fa-trash"></i></button></td></tr>` }) }
        function delInv(i){ if(confirm("Delete?")){invoices=invoices.filter(x=>x.id!=i);localStorage.setItem('agDataV46',JSON.stringify(invoices));renderTable();updateStats();checkAlerts()} }
        function updateStats(){ let r=0,e=0,p=0; invoices.forEach(i=>{r+=i.total;if(i.status=='Pending')p+=i.total}); expenses.forEach(x=>e+=x.amt); document.getElementById('stRev').innerText="$"+r.toFixed(2); document.getElementById('stExp').innerText="$"+e.toFixed(2); document.getElementById('stProf').innerText="$"+(r-e).toFixed(2) }
        function renderChart(){ const c=document.getElementById('revenueChart').getContext('2d'); if(myChart)myChart.destroy(); const l=[],r=[],e=[]; for(let i=5;i>=0;i--){ const d=new Date(); d.setMonth(d.getMonth()-i); const k=d.toISOString().slice(0,7); l.push(d.toLocaleString('default',{month:'short'})); r.push(invoices.filter(x=>x.date.startsWith(k)).reduce((a,b)=>a+b.total,0)); e.push(expenses.filter(x=>x.date.startsWith(k)).reduce((a,b)=>a+b.amt,0)) } myChart=new Chart(c,{type:'bar',data:{labels:l,datasets:[{label:'Revenue',data:r,backgroundColor:'#2563eb',borderRadius:4},{label:'Expenses',data:e,backgroundColor:'#ef4444',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false}}) }
        function saveClient(){ const n=document.getElementById('cliName').value; if(!n)return; clients.push({name:n,phone:document.getElementById('cliPhone').value}); localStorage.setItem('agCliV46',JSON.stringify(clients)); renderClients() }
        function renderClients(){ const t=document.getElementById('clientTable'); t.innerHTML=""; clients.forEach((c,i)=>{t.innerHTML+=`<tr><td>${c.name}</td><td>${c.phone}</td><td><i class="fas fa-trash" style="color:red;cursor:pointer" onclick="delCli(${i})"></i></td></tr>`}) }
        function delCli(i){ clients.splice(i,1); localStorage.setItem('agCliV46',JSON.stringify(clients)); renderClients() }
        function saveExpense(){ const d=document.getElementById('expDesc').value, a=parseFloat(document.getElementById('expAmt').value); if(!d||!a)return; expenses.unshift({id:Date.now(),desc:d,amt:a,date:new Date().toISOString().split('T')[0]}); localStorage.setItem('agExpV46',JSON.stringify(expenses)); document.getElementById('expDesc').value=""; document.getElementById('expAmt').value=""; renderExpenses(); updateStats(); renderChart() }
        function renderExpenses(){ const t=document.getElementById('expenseTable'); t.innerHTML=""; expenses.forEach(e=>{t.innerHTML+=`<tr><td>${e.desc}</td><td>${e.date}</td><td>$${e.amt.toFixed(2)}</td><td><i class="fas fa-trash" style="color:red;cursor:pointer" onclick="delExp(${e.id})"></i></td></tr>`}) }
        function delExp(i){ expenses=expenses.filter(e=>e.id!=i); localStorage.setItem('agExpV46',JSON.stringify(expenses)); renderExpenses(); updateStats(); renderChart() }
        function fillTemplate(d){ document.getElementById('outNum').innerText=d.num; document.getElementById('outDate').innerText=d.date; document.getElementById('outClient').innerText=d.client; document.getElementById('outDue').innerText=d.dueDate||d.date; document.getElementById('outItems').innerHTML=d.items.map(i=>`<tr><td style="padding:10px 0;border-bottom:1px solid #eee">${i.desc}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">$${i.price}</td><td style="text-align:right;font-weight:700">$${(i.qty*i.price).toFixed(2)}</td></tr>`).join(''); document.getElementById('outTotal').innerText="$"+d.total.toFixed(2); document.getElementById('outKhr').innerText=(d.total*(localStorage.getItem('agRate')||4100)).toLocaleString()+" ៛" }
        function downloadData(){ const a=document.createElement("a"); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({inv:invoices,cli:clients,exp:expenses})); a.download="Backup.json"; a.click() }
    </script>
</body>
</html>