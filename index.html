<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reaksa Ads - V46 Khmer & Logo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@300;400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CSS Variables */
        :root {
            --bg-body: #f1f5f9; --sidebar-bg: #0f172a; --card-bg: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
            --primary: #2563eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --font-main: 'Inter', 'Battambang', sans-serif;
        }
        body.dark-mode {
            --bg-body: #0f172a; --sidebar-bg: #1e293b; --card-bg: #1e293b;
            --text-main: #f8fafc; --text-sub: #94a3b8; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); transition: background-color 0.2s, color 0.2s; }
        
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; border-right: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .app-logo { width: 50px; height: 50px; border-radius: 10px; margin-bottom: 10px; object-fit: contain; background: white; padding: 5px; }
        
        .menu-item { padding: 12px 20px; margin: 0 10px 5px; border-radius: 8px; cursor: pointer; color: #94a3b8; display: flex; gap: 12px; align-items: center; font-size: 14px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; position: relative; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }

        /* COMPONENTS */
        .white-box { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-main); outline: none; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; background: var(--bg-body); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text-sub); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; font-family: var(--font-main); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-dark { background: #334155; color: white; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .bg-paid { background: #dcfce7; color: #166534; } 
        .bg-pending { background: #f3f4f6; color: #4b5563; }
        .bg-overdue { background: #fee2e2; color: #991b1b; } 
        .bg-due { background: #fef3c7; color: #b45309; }

        .alert-box { background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; margin-bottom: 20px; border-radius: 6px; display: none; }

        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .inp-login { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { display: none; } .stats-grid { grid-template-columns: 1fr; } }
        
        /* INVOICE HIDDEN */
        #invoice-capture { position: fixed; left: -9999px; top: 0; width: 800px; background: white; padding: 50px; font-family: 'Inter', sans-serif; color: #111827; z-index: -1; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <div style="margin-bottom: 20px;">
                <img src="" id="loginLogoImg" style="width: 80px; margin-bottom: 10px; border-radius: 10px; display: none;">
                <h2 style="color: var(--text-main); margin-top: 10px;">Reaksa Ads</h2>
                <p style="color: var(--text-sub); font-size: 14px;">System V46 - Khmer & Logo</p>
            </div>
            <input type="text" id="loginEmail" class="inp-login" placeholder="Email (adsreaksa@gmail.com)">
            <input type="password" id="loginPass" class="inp-login" placeholder="Password (adsreaksa050796)">
            <button onclick="checkLogin()" class="btn-login">Login Account</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="" id="appLogoDisplay" class="app-logo" style="display:none;">
            <div style="font-size: 18px; font-weight: 800;">AGENCY PRO</div>
            <div style="font-size: 11px; opacity: 0.7;">INTELLIGENT SOLUTIONS</div>
        </div>
        <div class="menu-item active" id="nav-dash" onclick="switchTab('dash')"><i class="fas fa-th-large"></i> <span class="lang-dash">Dashboard</span></div>
        <div class="menu-item" id="nav-inv" onclick="switchTab('inv')"><i class="fas fa-file-invoice"></i> <span class="lang-inv">Invoices</span></div>
        <div class="menu-item" id="nav-exp" onclick="switchTab('exp')"><i class="fas fa-chart-pie"></i> <span class="lang-exp">Expenses</span></div>
        <div class="menu-item" id="nav-cli" onclick="switchTab('cli')"><i class="fas fa-users"></i> <span class="lang-cli">Clients</span></div>
        <div class="menu-item" id="nav-set" onclick="switchTab('set')"><i class="fas fa-cog"></i> <span class="lang-set">Settings</span></div>
    </aside>

    <main class="main-content">
        <div class="scroll-area">
            
            <div id="view-dash" class="view-section">
                <div id="alertBox" class="alert-box">
                    <h4 style="margin:0 0 5px 0; color:#991b1b;"><i class="fas fa-bell"></i> Alert</h4>
                    <p style="margin:0; font-size:14px; color:#7f1d1d;" id="alertMsg"></p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-rev">REVENUE</small><h2 style="color:var(--primary)" id="stRev">$0.00</h2></div><i class="fas fa-wallet" style="font-size:24px; color:var(--primary)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-exp-cost">EXPENSES</small><h2 style="color:var(--danger)" id="stExp">$0.00</h2></div><i class="fas fa-arrow-down" style="font-size:24px; color:var(--danger)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-prof">PROFIT</small><h2 style="color:var(--success)" id="stProf">$0.00</h2></div><i class="fas fa-chart-line" style="font-size:24px; color:var(--success)"></i></div>
                    <div class="stat-card"><div><small style="color:var(--text-sub)" class="lang-over">OVERDUE</small><h2 style="color:var(--danger)" id="stDue">0</h2></div><i class="fas fa-exclamation-circle" style="font-size:24px; color:var(--danger)"></i></div>
                </div>

                <div class="white-box" style="height: 350px; position: relative;">
                    <h3 style="margin-bottom: 20px;" class="lang-chart">Financial Overview</h3>
                    <canvas id="revenueChart"></canvas>
                </div>

                <div class="white-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3 id="formTitle" class="lang-new-inv">Create New Invoice</h3>
                        <button onclick="resetForm()" class="btn" id="btnCancel" style="background:var(--text-main); color:white; display:none;">Cancel</button>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div>
                            <label style="font-size:12px; font-weight:600;" class="lang-client">Client Name</label>
                            <input type="text" id="inpClient" class="form-control" placeholder="Select Client" list="clientList">
                            <datalist id="clientList"></datalist>
                        </div>
                        <div>
                            <label style="font-size:12px; font-weight:600;">Invoice #</label>
                            <input type="text" id="inpInvNum" class="form-control" placeholder="INV-001">
                        </div>
                        <div>
                            <label style="font-size:12px; font-weight:600;" class="lang-date">Start Date</label>
                            <input type="date" id="inpDate" class="form-control">
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                        <label style="font-size:12px; font-weight:600; color:var(--danger);" class="lang-due">Payment Due Date</label>
                        <input type="date" id="inpDue" class="form-control" style="border-color:var(--danger);">
                    </div>

                    <div style="overflow-x:auto;">
                        <table style="margin-bottom:15px;">
                            <thead><tr><th class="lang-desc">Description</th><th style="width:100px;">Qty</th><th style="width:150px;">Price ($)</th><th style="width:50px;"></th></tr></thead>
                            <tbody id="itemContainer"></tbody>
                        </table>
                    </div>
                    <button onclick="addRow()" class="btn" style="background:#eff6ff; color:var(--primary);">+ Add Item</button>

                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <select id="inpStatus" class="form-control" style="width:150px;"><option value="Pending">Pending</option><option value="Paid">Paid</option></select>
                            <span style="font-size:18px; font-weight:700;">Total: <span id="displayTotal">$0.00</span></span>
                        </div>
                        <button onclick="saveInvoice()" class="btn btn-primary" id="btnSave">Save Invoice</button>
                    </div>
                </div>
            </div>

            <div id="view-inv" class="view-section" style="display:none;">
                <div class="white-box" style="padding:0; overflow:hidden;">
                    <div style="padding:20px; border-bottom:1px solid var(--border);"><h3 class="lang-hist">Invoices History</h3></div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;">
                            <thead><tr><th>ID</th><th class="lang-client">Client</th><th class="lang-date">Date</th><th class="lang-due">Due Date</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="invoiceTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-exp" class="view-section" style="display:none;"><div class="white-box"><h3 class="lang-exp">Expenses</h3><div style="display:flex; gap:10px; margin:15px 0;"><input id="expDesc" class="form-control" placeholder="Description"><input type="number" id="expAmt" class="form-control" placeholder="Amount"><button onclick="saveExpense()" class="btn btn-danger">Add</button></div><table style="width:100%"><thead><tr><th>Desc</th><th>Date</th><th>Amount</th><th>Action</th></tr></thead><tbody id="expenseTable"></tbody></table></div></div>
            <div id="view-cli" class="view-section" style="display:none;"><div class="white-box"><h3 class="lang-cli">Clients</h3><div style="display:flex; gap:10px; margin:15px 0;"><input id="cliName" class="form-control" placeholder="Name"><input id="cliPhone" class="form-control" placeholder="Phone"><button onclick="saveClient()" class="btn btn-primary">Add</button></div><table style="width:100%"><thead><tr><th>Name</th><th>Phone</th><th>Action</th></tr></thead><tbody id="clientTable"></tbody></table></div></div>
            
            <div id="view-set" class="view-section" style="display:none;">
                <div class="white-box">
                    <h3 class="lang-set">Settings</h3>
                    <div style="margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div><b>System Language</b><br><small>ភាសា</small></div>
                            <select id="langSelect" class="form-control" style="width:150px;" onchange="changeLang(this.value)">
                                <option value="en">English</option>
                                <option value="km">ភាសាខ្មែរ</option>
                            </select>
                        </div>

                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div><b>Company Logo</b><br><small>Upload logo for invoice</small></div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="file" id="logoInput" style="display:none;" onchange="uploadLogo(this)">
                                <button onclick="document.getElementById('logoInput').click()" class="btn btn-primary">Upload</button>
                                <button onclick="removeLogo()" class="btn btn-danger">Remove</button>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div><b>Test Telegram Connection</b><br><small>Check Bot</small></div>
                            <button onclick="testTelegram()" class="btn btn-success"><i class="fab fa-telegram"></i> Test</button>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>Exchange Rate</span><input id="setRate" class="form-control" style="width:100px;" value="4100" onchange="localStorage.setItem('agRate',this.value)"></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>Data Backup</span><button onclick="downloadData()" class="btn btn-dark">Download</button></div>
                        <div style="display:flex; justify-content:space-between;"><span>Reset System</span><button onclick="if(confirm('Delete All?')){localStorage.clear();location.reload()}" class="btn btn-danger">Reset</button></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="invoice-capture">
        <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
            <div>
                <img src="" id="invLogo" style="height:60px; display:none; margin-bottom:10px;">
                <h1 style="margin:0; font-size:26px;" id="invBrandName">Reaksa Ads</h1>
                <p style="margin:5px 0; color:#6b7280; font-size:12px; letter-spacing:2px;">INTELLIGENT SOLUTIONS</p>
            </div>
            <div style="text-align:right;"><h2 style="margin:0; color:#2563eb;">INVOICE</h2><div style="color:#6b7280;"># <span id="outNum"></span></div></div>
        </div>
        <div style="display:flex; justify-content:space-between; background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:30px;">
            <div><div style="font-size:11px; color:#6b7280; font-weight:700;">BILL TO</div><div style="font-size:16px; font-weight:700;" id="outClient"></div></div>
            <div style="text-align:right;"><div style="font-size:11px; color:#6b7280; font-weight:700;">PAYMENT DUE</div><div style="font-size:16px; font-weight:700; color:#ef4444;" id="outDue"></div></div>
        </div>
        <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
            <thead><tr style="border-bottom:2px solid #e5e7eb;"><th style="text-align:left; padding:10px 0;">DESCRIPTION</th><th style="text-align:center;">QTY</th><th style="text-align:right;">PRICE</th><th style="text-align:right;">TOTAL</th></tr></thead>
            <tbody id="outItems"></tbody>
        </table>
        <div style="display:flex; justify-content:flex-end;"><div style="width:250px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Total (USD)</span><span id="outTotal" style="font-weight:700;">$0.00</span></div><div style="display:flex; justify-content:space-between; color:#6b7280;"><span>Total (KHR)</span><span id="outKhr">0 ៛</span></div></div></div>
        <div style="margin-top:50px; border-top:1px solid #e5e7eb; padding-top:20px; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; gap:15px; align-items:center;"><img src="https://i.postimg.cc/NM5461RZ/aba_qr.jpg" style="width:80px;" crossorigin="anonymous"><div><div style="font-size:12px; font-weight:700;">ABA: 002 060 042</div><div style="font-size:12px;">Reaksa Ads</div></div></div>
            <div style="text-align:right; font-size:12px; color:#6b7280;"><div>015 812 050 | 068 566 402</div><div>t.me/ReaksaAds</div></div>
        </div>
    </div>

    <script>
        const BOT_TOKEN = "8269889459:AAFCHuvYXeEVzcK7bsWqxPvFgQp8yMwGVAQ"; const CHAT_ID = "6459933568"; 
        let invoices = JSON.parse(localStorage.getItem('agDataV46'))||[], clients = JSON.parse(localStorage.getItem('agCliV46'))||[], expenses = JSON.parse(localStorage.getItem('agExpV46'))||[];
        let myChart = null, editingId = null;
        
        // TRANSLATIONS
        const trans = {
            en: {
                dash: "Dashboard", inv: "Invoices", exp: "Expenses", cli: "Clients", set: "Settings",
                rev: "REVENUE", exp_cost: "EXPENSES", prof: "PROFIT", over: "OVERDUE",
                chart: "Financial Overview", new_inv: "Create New Invoice", client: "Client Name",
                date: "Issue Date", due: "Payment Due Date", desc: "Description", hist: "Invoice History"
            },
            km: {
                dash: "ផ្ទាំងគ្រប់គ្រង", inv: "វិក្កយបត្រ", exp: "ចំណាយ", cli: "អតិថិជន", set: "ការកំណត់",
                rev: "ចំណូលសរុប", exp_cost: "ចំណាយសរុប", prof: "ប្រាក់ចំណេញ", over: "ហួសកំណត់",
                chart: "របាយការណ៍ហិរញ្ញវត្ថុ", new_inv: "បង្កើតវិក្កយបត្រថ្មី", client: "ឈ្មោះអតិថិជន",
                date: "ថ្ងៃចេញវិក្កយបត្រ", due: "ថ្ងៃត្រូវបង់លុយ", desc: "បរិយាយ", hist: "ប្រវត្តិវិក្កយបត្រ"
            }
        };

        function checkLogin() {
            if(document.getElementById('loginEmail').value==="adsreaksa@gmail.com" && document.getElementById('loginPass').value==="adsreaksa050796") {
                document.getElementById('loginOverlay').style.display='none'; initApp();
            } else alert("Invalid Login");
        }

        function initApp() {
            document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('setRate').value = localStorage.getItem('agRate')||4100;
            
            // Load Settings
            const savedLang = localStorage.getItem('agLang') || 'en';
            document.getElementById('langSelect').value = savedLang;
            changeLang(savedLang);
            loadLogo();

            updateStats(); renderTable(); renderClients(); renderExpenses(); addRow(); genInvNum(); renderChart(); checkAlerts();
        }

        // --- LANGUAGE & LOGO ---
        function changeLang(lang) {
            localStorage.setItem('agLang', lang);
            document.querySelector('.lang-dash').innerText = trans[lang].dash;
            document.querySelector('.lang-inv').innerText = trans[lang].inv;
            document.querySelector('.lang-exp').innerText = trans[lang].exp;
            document.querySelector('.lang-cli').innerText = trans[lang].cli;
            document.querySelector('.lang-set').innerText = trans[lang].set;
            document.querySelector('.lang-rev').innerText = trans[lang].rev;
            document.querySelector('.lang-exp-cost').innerText = trans[lang].exp_cost;
            document.querySelector('.lang-prof').innerText = trans[lang].prof;
            document.querySelector('.lang-over').innerText = trans[lang].over;
            document.querySelector('.lang-chart').innerText = trans[lang].chart;
            document.querySelector('.lang-new-inv').innerText = trans[lang].new_inv;
            document.querySelector('.lang-client').innerText = trans[lang].client;
            document.querySelector('.lang-date').innerText = trans[lang].date;
            document.querySelector('.lang-due').innerText = trans[lang].due;
            document.querySelector('.lang-desc').innerText = trans[lang].desc;
            document.querySelector('.lang-hist').innerText = trans[lang].hist;
        }

        function uploadLogo(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    localStorage.setItem('agLogo', e.target.result);
                    loadLogo();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() { localStorage.removeItem('agLogo'); loadLogo(); }

        function loadLogo() {
            const logo = localStorage.getItem('agLogo');
            const display = document.getElementById('appLogoDisplay');
            const invImg = document.getElementById('invLogo');
            const invTxt = document.getElementById('invBrandName');
            const loginLogo = document.getElementById('loginLogoImg');

            if(logo) {
                display.src = logo; display.style.display = 'block';
                invImg.src = logo; invImg.style.display = 'block';
                loginLogo.src = logo; loginLogo.style.display = 'block';
                invTxt.style.display = 'none'; // Hide text if logo exists
            } else {
                display.style.display = 'none';
                invImg.style.display = 'none';
                loginLogo.style.display = 'none';
                invTxt.style.display = 'block';
            }
        }

        // --- TEST CONNECTION ---
        function testTelegram() {
            const btn = event.target; const originalText = btn.innerHTML; btn.innerHTML = "Sending...";
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: CHAT_ID, text: "✅ System Connected Successfully!" })
            }).then(res => res.json()).then(data => {
                if(data.ok) alert("✅ Success!"); else alert("❌ Error: " + data.description);
            }).catch(err => alert("❌ Network Error")).finally(() => btn.innerHTML = originalText);
        }

        // --- CORE FUNCTIONS (Same as V45) ---
        function sendTelegram(data) {
            fillTemplate(data); const btn = event.target.closest('button'); const originalIcon = btn.innerHTML; btn.innerText = "...";
            setTimeout(() => {
                html2canvas(document.getElementById("invoice-capture"), { scale: 2, useCORS: true }).then(canvas => {
                    canvas.toBlob(blob => {
                        const formData = new FormData(); formData.append('chat_id', CHAT_ID); formData.append('photo', blob);
                        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: formData })
                        .then(res => res.json()).then(d => { if(d.ok) { btn.innerHTML='✅'; setTimeout(()=>btn.innerHTML=originalIcon,2000); } else alert("Error: "+d.description); });
                    });
                });
            }, 500);
        }

        function checkAlerts() {
            const today = new Date().toISOString().split('T')[0]; let dueCount = 0;
            invoices.forEach(i => { if(i.status !== 'Paid' && i.dueDate && i.dueDate <= today) dueCount++; });
            if(dueCount > 0) { document.getElementById('alertBox').style.display = 'block'; document.getElementById('alertMsg').innerText = `You have ${dueCount} overdue invoices!`; document.getElementById('stDue').innerText = dueCount; }
            else { document.getElementById('alertBox').style.display = 'none'; document.getElementById('stDue').innerText = "0"; }
        }

        function switchTab(id){ document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); document.querySelectorAll('.view-section').forEach(e=>e.style.display='none'); document.getElementById('view-'+id).style.display='block'; if(id==='dash') renderChart(); }
        function addRow(d='',q=1,p=''){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input class="form-control i-desc" value="${d}"></td><td><input type="number" class="form-control i-qty" value="${q}" oninput="calc()"></td><td><input type="number" class="form-control i-price" value="${p}" oninput="calc()"></td><td><i class="fas fa-times" style="color:var(--danger);cursor:pointer;" onclick="this.closest('tr').remove();calc()"></i></td>`; document.getElementById('itemContainer').appendChild(tr); }
        function calc(){ let t=0; document.querySelectorAll('#itemContainer tr').forEach(r=>{ t+=(r.querySelector('.i-qty').value||0)*(r.querySelector('.i-price').value||0); }); document.getElementById('displayTotal').innerText="$"+t.toFixed(2); return t; }
        function genInvNum(){ if(!editingId) document.getElementById('inpInvNum').value="INV-"+(invoices.length+1).toString().padStart(3,'0'); }

        function saveInvoice(){
            const c=document.getElementById('inpClient').value; if(!c) return alert("Client Name?");
            const items=[]; document.querySelectorAll('#itemContainer tr').forEach(r=>{ if(r.querySelector('.i-desc').value) items.push({desc:r.querySelector('.i-desc').value, qty:r.querySelector('.i-qty').value, price:r.querySelector('.i-price').value}); });
            if(items.length==0) return alert("Items?");
            const inv={ id:editingId||Date.now(), num:document.getElementById('inpInvNum').value, client:c, items, total:calc(), status:document.getElementById('inpStatus').value, date:document.getElementById('inpDate').value, dueDate:document.getElementById('inpDue').value };
            if(editingId){ invoices[invoices.findIndex(i=>i.id===editingId)]=inv; alert("Updated!"); } else { invoices.unshift(inv); alert("Saved!"); }
            localStorage.setItem('agDataV46',JSON.stringify(invoices)); resetForm(); updateStats(); renderTable(); renderChart(); checkAlerts();
        }

        function resetForm(){ editingId=null; document.getElementById('inpClient').value=""; document.getElementById('inpDue').value=""; document.getElementById('itemContainer').innerHTML=""; document.getElementById('formTitle').innerText="Create New Invoice"; document.getElementById('btnSave').innerText="Save Invoice"; document.getElementById('btnCancel').style.display='none'; addRow(); genInvNum(); calc(); }
        
        function editInv(dStr){ 
            const d=JSON.parse(decodeURIComponent(dStr)); editingId=d.id; 
            document.getElementById('inpClient').value=d.client; document.getElementById('inpInvNum').value=d.num; 
            document.getElementById('inpDate').value=d.date; document.getElementById('inpStatus').value=d.status; document.getElementById('inpDue').value=d.dueDate || "";
            document.getElementById('itemContainer').innerHTML=""; d.items.forEach(i=>addRow(i.desc,i.qty,i.price)); calc(); 
            document.getElementById('formTitle').innerText="Edit Invoice"; document.getElementById('btnSave').innerText="Update"; document.getElementById('btnCancel').style.display='inline-flex'; switchTab('dash'); 
        }

        function renderTable(){ 
            const tb=document.getElementById('invoiceTable'); tb.innerHTML=""; const today = new Date().toISOString().split('T')[0];
            invoices.forEach(i=>{ 
                let badge='bg-pending', txt=i.status;
                if(i.status==='Paid') badge='bg-paid';
                else if(i.dueDate && i.dueDate < today) { badge='bg-overdue'; txt='Overdue'; }
                else if(i.dueDate && i.dueDate === today) { badge='bg-due'; txt='Due Today'; }
                const ds=encodeURIComponent(JSON.stringify(i)); 
                tb.innerHTML+=`<tr><td>${i.num}</td><td>${i.client}</td><td>${i.date}</td><td style="color:${badge==='bg-overdue'?'red':'inherit'}">${i.dueDate||'-'}</td><td>$${i.total.toFixed(2)}</td><td><span class="badge ${badge}">${txt}</span></td><td style="display:flex; gap:8px;"><button class="btn" style="background:#eff6ff;color:blue" onclick="editInv('${ds}')"><i class="fas fa-edit"></i></button><button class="btn" style="background:#ecfdf5;color:green" onclick='sendTelegram(${JSON.stringify(i)})'><i class="fab fa-telegram"></i></button><button class="btn" style="background:#fee2e2;color:red" onclick="delInv(${i.id})"><i class="fas fa-trash"></i></button></td></tr>`; 
            }); 
        }
        function delInv(id){ if(confirm("Delete?")){ invoices=invoices.filter(i=>i.id!=id); localStorage.setItem('agDataV46',JSON.stringify(invoices)); renderTable(); updateStats(); checkAlerts(); } }

        function updateStats(){ let r=0,e=0,p=0; invoices.forEach(i=>{ r+=i.total; if(i.status=='Pending') p+=i.total; }); expenses.forEach(x=>e+=x.amt); document.getElementById('stRev').innerText="$"+r.toFixed(2); document.getElementById('stExp').innerText="$"+e.toFixed(2); document.getElementById('stProf').innerText="$"+(r-e).toFixed(2); }
        function renderChart(){ const ctx=document.getElementById('revenueChart').getContext('2d'); if(myChart)myChart.destroy(); const l=[],r=[],e=[]; for(let i=5;i>=0;i--){ const d=new Date(); d.setMonth(d.getMonth()-i); const k=d.toISOString().slice(0,7); l.push(d.toLocaleString('default',{month:'short'})); r.push(invoices.filter(x=>x.date.startsWith(k)).reduce((a,b)=>a+b.total,0)); e.push(expenses.filter(x=>x.date.startsWith(k)).reduce((a,b)=>a+b.amt,0)); } myChart=new Chart(ctx,{ type:'bar', data:{labels:l,datasets:[{label:'Revenue',data:r,backgroundColor:'#2563eb',borderRadius:4},{label:'Expenses',data:e,backgroundColor:'#ef4444',borderRadius:4}]}, options:{responsive:true,maintainAspectRatio:false} }); }

        function saveClient(){ const n=document.getElementById('cliName').value; if(!n)return; clients.push({name:n, phone:document.getElementById('cliPhone').value}); localStorage.setItem('agCliV46',JSON.stringify(clients)); renderClients(); }
        function renderClients(){ const t=document.getElementById('clientTable'); t.innerHTML=""; clients.forEach((c,i)=>{ t.innerHTML+=`<tr><td>${c.name}</td><td>${c.phone}</td><td><i class="fas fa-trash" style="color:red;cursor:pointer;" onclick="delCli(${i})"></i></td></tr>`; }); }
        function delCli(i){ clients.splice(i,1); localStorage.setItem('agCliV46',JSON.stringify(clients)); renderClients(); }
        
        function saveExpense(){ const d=document.getElementById('expDesc').value, a=parseFloat(document.getElementById('expAmt').value); if(!d||!a)return; expenses.unshift({id:Date.now(), desc:d, amt:a, date:new Date().toISOString().split('T')[0]}); localStorage.setItem('agExpV46',JSON.stringify(expenses)); document.getElementById('expDesc').value=""; document.getElementById('expAmt').value=""; renderExpenses(); updateStats(); renderChart(); }
        function renderExpenses(){ const tb=document.getElementById('expenseTable'); tb.innerHTML=""; expenses.forEach(e=>tb.innerHTML+=`<tr><td>${e.desc}</td><td>${e.date}</td><td>$${e.amt.toFixed(2)}</td><td><i class="fas fa-trash" style="color:var(--danger);cursor:pointer;" onclick="delExp(${e.id})"></i></td></tr>`); }
        function delExp(id){ expenses=expenses.filter(e=>e.id!=id); localStorage.setItem('agExpV46',JSON.stringify(expenses)); renderExpenses(); updateStats(); renderChart(); }

        function fillTemplate(d){ document.getElementById('outNum').innerText=d.num; document.getElementById('outDate').innerText=d.date; document.getElementById('outClient').innerText=d.client; document.getElementById('outDue').innerText=d.dueDate || d.date; document.getElementById('outItems').innerHTML=d.items.map(i=>`<tr><td style="padding:10px 0; border-bottom:1px solid #eee;">${i.desc}</td><td style="text-align:center;">${i.qty}</td><td style="text-align:right;">$${i.price}</td><td style="text-align:right; font-weight:700;">$${(i.qty*i.price).toFixed(2)}</td></tr>`).join(''); document.getElementById('outTotal').innerText="$"+d.total.toFixed(2); document.getElementById('outKhr').innerText=(d.total*(localStorage.getItem('agRate')||4100)).toLocaleString()+" ៛"; }
        
        function downloadData(){ const a=document.createElement("a"); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({inv:invoices,cli:clients,exp:expenses})); a.download="Backup.json"; a.click(); }
        function restoreData(i){ const r=new FileReader(); r.onload=e=>{ const d=JSON.parse(e.target.result); if(d.inv){ localStorage.setItem('agDataV46',JSON.stringify(d.inv)); localStorage.setItem('agCliV46',JSON.stringify(d.cli)); localStorage.setItem('agExpV46',JSON.stringify(d.exp)); location.reload(); } }; r.readAsText(i.files[0]); }
    </script>
</body>
</html>